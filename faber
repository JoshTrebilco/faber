#!/bin/bash

#############################################
# Faber - Server Management CLI
# Version: 1.0.0
# Author: Josh Trebilco
# License: MIT
#############################################

set -e

# Paths
FABER_LIB_DIR="/opt/faber/lib"
FABER_DATA_DIR="/etc/faber"
FABER_BIN="/usr/local/bin/faber"
FABER_BIN_ALIAS="/usr/local/bin/fab"
FABER_VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Load library functions
if [ -d "${FABER_LIB_DIR}" ]; then
    for lib in "${FABER_LIB_DIR}"/*.sh; do
        [ -f "$lib" ] && source "$lib"
    done
    # Initialize storage once at startup
    init_storage
fi

# Check if running as root
check_root() {
    if [ "$(id -u)" != "0" ]; then
        echo -e "${RED}${BOLD}Error: Faber must be run as root${NC}"
        echo -e "Please run with sudo or as root user"
        exit 1
    fi
}

# Display logo
show_logo() {
    echo -e "${GREEN}${BOLD}"
    echo " _______ _______ ______  _______ ______  "
    echo "(_______|_______|____  \(_______|_____ \ "
    echo " _____   _______ ____)  )_____   _____) )"
    echo "|  ___) |  ___  |  __  (|  ___) |  __  / "
    echo "| |     | |   | | |__)  ) |_____| |  \ \ "
    echo "|_|     |_|   |_|______/|_______)_|   |_|"
    echo ""
    echo "  Laravel Deployment and Server Manager  "
    echo ""
    echo -e "${NC}"
}

# Display version
show_version() {
    show_logo
    echo -e "Version: ${CYAN}${FABER_VERSION}${NC}"
    
    # Show commit hash if available
    if [ -f "/etc/faber/version.json" ]; then
        local commit=$(jq -r '.commit // empty' /etc/faber/version.json 2>/dev/null)
        if [ -n "$commit" ] && [ "$commit" != "null" ]; then
            echo -e "Commit:  ${CYAN}${commit:0:7}${NC}"
        fi
    fi
    
    echo ""
}

# Display help (compact version - default)
show_help() {
    show_help_compact
}

# Check for --help flag in arguments
check_help_flag() {
    for arg in "$@"; do
        if [ "$arg" = "--help" ] || [ "$arg" = "-h" ] || [ "$arg" = "help" ]; then
            return 0
        fi
    done
    return 1
}

# Main command router
main() {
    # If no command provided, show compact help
    if [ $# -eq 0 ]; then
        show_help_compact
        exit 0
    fi

    # Root check is now done at the top of the script

    COMMAND=$1
    shift

    # Check if help was requested
    if [ "$COMMAND" = "help" ] || [ "$COMMAND" = "--help" ] || [ "$COMMAND" = "-h" ]; then
        # Check for interactive mode
        if [ "$1" = "-i" ] || [ "$1" = "--interactive" ]; then
            show_help_interactive
            exit 0
        fi
        # Check if specific command help requested
        if [ -n "$1" ]; then
            show_help_command "$1"
            exit 0
        fi
        # Show full help
        show_help_full
        exit 0
    fi

    # Check for --help flag in remaining args (for subcommands)
    if check_help_flag "$@"; then
        # Extract command context for help
        case $COMMAND in
            stack|app|domain|database|php|service|webhook|reverb)
                local subcmd="$1"
                if [ -n "$subcmd" ] && [ "$subcmd" != "--help" ] && [ "$subcmd" != "-h" ]; then
                    show_help_subcommand "$COMMAND" "$subcmd"
                else
                    show_help_command "$COMMAND"
                fi
                ;;
            *)
                show_help_command "$COMMAND"
                ;;
        esac
        exit 0
    fi

    case $COMMAND in
        status)
            cmd_status "$@"
            ;;
        version)
            show_version
            ;;
        config)
            cmd_config "$@"
            ;;
        stack)
            cmd_stack "$@"
            ;;
        app)
            cmd_app "$@"
            ;;
        domain)
            cmd_domain "$@"
            ;;
        database)
            cmd_database "$@"
            ;;
        php)
            cmd_php "$@"
            ;;
        service)
            cmd_service "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        webhook)
            cmd_webhook "$@"
            ;;
        reverb)
            cmd_reverb "$@"
            ;;
        update)
            cmd_update "$@"
            ;;
        deploy)
            cmd_deploy "$@"
            ;;
        *)
            echo -e "${RED}Unknown command: $COMMAND${NC}"
            echo ""
            local suggestion=$(suggest_command "$COMMAND")
            if [ -n "$suggestion" ]; then
                echo -e "Did you mean: ${CYAN}$suggestion${NC}?"
                echo ""
            fi
            show_help_compact
            exit 1
            ;;
    esac
}

# Run main
main "$@"
